#!/usr/bin/env bash
set -euo pipefail

# Policy:
# - ALLOW_SUDO=1  -> prova root checks non-interattivi
# - STRICT=1      -> se root checks richiesti ma impossibili/KO, esci con code 2
ALLOW_SUDO="${ALLOW_SUDO:-0}"
STRICT="${STRICT:-0}"

echo "=== SECURITY HEALTHCHECK ==="

echo
echo ">>> Sudo events (ultime 24h)"
journalctl _COMM=sudo --since "24 hours ago" --no-pager -n 20 || echo "nessun evento sudo"

echo
echo ">>> Login / logout (ultime 24h)"
journalctl -u systemd-logind --since "24 hours ago" --no-pager -n 20 || echo "nessun evento logind"

echo
echo ">>> UFW events (ultime 24h)"
journalctl -k --since "24 hours ago" --no-pager | grep -i ufw | tail -n 20 || echo "nessun log UFW rilevante"

echo
echo ">>> Kernel warnings (ultimo boot)"
journalctl -k -p warning --boot --no-pager -n 50 || echo "nessun warning kernel"

rc=0

if command -v debsums >/dev/null 2>&1; then
  echo
  echo ">>> Debsums core packages (root integrity check)"

  if [[ "$ALLOW_SUDO" != "1" ]]; then
    echo "ROOT_CHECKS=SKIPPED (ALLOW_SUDO=0)"
  else
    if ! sudo -n true 2>/dev/null; then
      # Unattended-friendly: se STRICT=0 non bloccare tutto
      echo "ROOT_CHECKS=SKIPPED (sudo non disponibile non-interattivo)"
      if [[ "$STRICT" == "1" ]]; then
        echo "ROOT_CHECKS=FAILED (STRICT=1)"
        rc=2
      fi
    else
      if sudo debsums -s sudo coreutils bash systemd systemd-sysv; then
        echo "ROOT_CHECKS=OK"
      else
        echo "ROOT_CHECKS=FAILED (debsums)"
        if [[ "$STRICT" == "1" ]]; then
          rc=2
        fi
      fi
    fi
  fi
else
  echo
  echo ">>> debsums non installato, salta check integrit√†."
fi

exit "$rc"
