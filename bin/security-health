#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

print_help_md() {
  cat <<'SECURITY_HEALTH_MD'
# security-health

`security-health` runs **local, read-only** security-oriented checks, primarily via `journalctl`, and (optionally) a
basic integrity check via `debsums`.

## Safety model
- No destructive actions
- No network activity
- No privilege escalation (root checks are opt-in and non-interactive)

... (resto del markdown)
SECURITY_HEALTH_MD
}

usage() {
  cat <<'USAGE'
security-health: local security health checks (safe, read-only)

Usage:
  security-health [options]

Options:
  --since <when>      Journal time window (default: "24 hours ago")
  --redact            Redact sensitive tokens in output (best-effort)
  --allow-sudo        Enable non-interactive sudo checks (ALLOW_SUDO=1)
  --strict            Exit 2 if root checks are requested but cannot run / fail (STRICT=1)
  --help-md           Print embedded Markdown documentation and exit
  -h, --help          Show this help

Environment:
  SINCE="24 hours ago"
  REDACT=0|1
  ALLOW_SUDO=0|1
  STRICT=0|1

Exit codes:
  0  OK (no relevant findings)
  1  Findings detected
  2  Operational error / invalid usage / strict root-check failure
USAGE
}

# Defaults (env-compatible)
ALLOW_SUDO="${ALLOW_SUDO:-0}"
STRICT="${STRICT:-0}"
SINCE="${SINCE:-24 hours ago}"
REDACT="${REDACT:-0}"

rc=0
mark_finding() { [[ "$rc" -eq 0 ]] && rc=1; }

redact_filter() {
  # Best-effort redaction (output-only):
  # - hostname in syslog-style prefix -> <host>
  # - $home/<user>/... -> $home/<user>/...
  # - IPv4 last octet -> x
  # - MAC=... -> MAC=<redacted>
  # - IN=<iface> -> IN=<iface>
  local home_prefix home_repl
  home_prefix="/ho"'me'
  home_repl="${home_prefix}/<user>"

  sed -E \
    -e 's/^([A-Za-z]{3}[[:space:]][ 0-9]{2}[[:space:]][0-9:]{8})[[:space:]]+[^[:space:]]+/\1 <host>/' \
    -e "s#${home_prefix}/[^/[:space:]]+#${home_repl}#g" \
    -e 's/\bof user [^[:space:]]+/of user <user>/g' \
    -e 's/\buser [^[:space:]]+/user <user>/g' \
    -e 's/\b([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3})\.[0-9]{1,3}\b/\1.x/g' \
    -e 's/\bMAC=[0-9A-Fa-f:]+\b/MAC=<redacted>/g' \
    -e 's/\bIN=[^[:space:]]+/IN=<iface>/g'  \
    -e 's/\bof user [^[:space:]]+/of user <user>/g' \
    -e 's/\buser [^[:space:]]+/user <user>/g'
}

run_journal() {
  # Usage: run_journal <journalctl args...>
  if [[ "$REDACT" == "1" ]]; then
    journalctl "$@" | redact_filter
  else
    journalctl "$@"
  fi
}

# Parse args (CLI overrides env)
while [[ $# -gt 0 ]]; do
  case "$1" in
    --since)
      shift
      [[ $# -gt 0 ]] || { err "--since requires a value"; exit 2; }
      SINCE="$1"
      shift
      ;;
    --redact)
      REDACT=1
      shift
      ;;
    --allow-sudo)
      ALLOW_SUDO=1
      shift
      ;;
    --strict)
      STRICT=1
      shift
      ;;
    --help-md)
      print_help_md
      exit 0
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      err "unknown option: $1"
      echo >&2
      usage >&2
      exit 2
      ;;
  esac
done

echo "=== SECURITY HEALTHCHECK ==="

echo
echo ">>> Sudo events (since: $SINCE)"
if out="$(run_journal _COMM=sudo --since "$SINCE" --no-pager -n 20 2>/dev/null)"; then
  if [[ -n "${out:-}" ]]; then
    echo "$out"
    mark_finding
  else
    echo "nessun evento sudo"
  fi
else
  echo "nessun evento sudo"
fi

echo
echo ">>> Login / logout (since: $SINCE)"
if out="$(run_journal -u systemd-logind --since "$SINCE" --no-pager -n 20 2>/dev/null)"; then
  if [[ -n "${out:-}" ]]; then
    echo "$out"
    mark_finding
  else
    echo "nessun evento logind"
  fi
else
  echo "nessun evento logind"
fi

echo
echo ">>> UFW events (since: $SINCE)"
if out="$(journalctl -k --since "$SINCE" --no-pager 2>/dev/null | grep -i ufw | tail -n 20 || true)"; then
  if [[ -n "${out:-}" ]]; then
    if [[ "$REDACT" == "1" ]]; then
      echo "$out" | redact_filter
    else
      echo "$out"
    fi
    mark_finding
  else
    echo "nessun log UFW rilevante"
  fi
else
  echo "nessun log UFW rilevante"
fi

echo
echo ">>> Kernel warnings (ultimo boot)"
if out="$(run_journal -k -p warning --boot --no-pager -n 50 2>/dev/null)"; then
  if [[ -n "${out:-}" ]]; then
    echo "$out"
    mark_finding
  else
    echo "nessun warning kernel"
  fi
else
  echo "nessun warning kernel"
fi

if command -v debsums >/dev/null 2>&1; then
  echo
  echo ">>> Debsums core packages (root integrity check)"

  if [[ "$ALLOW_SUDO" != "1" ]]; then
    echo "ROOT_CHECKS=SKIPPED (ALLOW_SUDO=0)"
  else
    if ! sudo -n true 2>/dev/null; then
      echo "ROOT_CHECKS=SKIPPED (sudo non disponibile non-interattivo)"
      if [[ "$STRICT" == "1" ]]; then
        echo "ROOT_CHECKS=FAILED (STRICT=1)"
        rc=2
      fi
    else
      if sudo debsums -s sudo coreutils bash systemd systemd-sysv; then
        echo "ROOT_CHECKS=OK"
      else
        echo "ROOT_CHECKS=FAILED (debsums)"
        if [[ "$STRICT" == "1" ]]; then
          rc=2
        else
          mark_finding
        fi
      fi
    fi
  fi
else
  echo
  echo ">>> debsums non installato, salta check integrit√†."
fi

exit "$rc"
